<routes xmlns="http://camel.apache.org/schema/spring">

    <!-- TODO(luis.pinto): which errorHandler to use? -->
    <route id="active-mq-publisher" errorHandlerRef="outBoundErrorHandler">
    
        <!-- TODO(luis.pinto) Make the delay configurable -->
        <from uri="scheduler:active_mq_publisher?initialDelay=15000&amp;delay=60000" />

        <log message="Fetching next 1000 sender sync messages" loggingLevel="DEBUG" />

        <toD uri="jpa:SenderSyncMessage?query=SELECT m FROM SenderSyncMessage m WHERE m.sent = false ORDER BY m.dateCreated ASC, m.id ASC&amp;maximumResults=1000" />

        <choice>
            <when>
                <simple>${body.size()} > 0</simple>
                <log message="Fetched ${body.size()} sender sync messages" />

                <split parallelProcessing="false">
                    <simple>${body}</simple>
                    <setProperty name="senderSyncMessage">
                        <simple>${body}</simple>
                    </setProperty>

                    <log message="Preparing sender sync messages -> ${exchangeProperty.senderSyncMessage}" />
                    
                    <choice>
                        <when>
                            <simple>${exchangeProperty.senderSyncMessage.operation} == 'd'</simple>
                            <setBody>
                                <spel>#{new org.openmrs.eip.component.model.SyncModel()}</spel>
                            </setBody>
                            <script>
                                <spel>
                                    #{body.setTableToSyncModelClass(T(org.openmrs.eip.component.service.TableToSyncEnum).getTableToSyncEnum(getProperty('senderSyncMessage').tableName).modelClass)}
                                    #{body.setModel(body.tableToSyncModelClass.getConstructor().newInstance())}
                                    #{body.model.setUuid(getProperty('senderSyncMessage').identifier)}
                                    #{body.setMetadata(new org.openmrs.eip.component.model.SyncMetadata())}
                                </spel>
                            </script>
            
                            <log message="Deleted entity payload -> ${body}" />
                        </when>
                        <otherwise>
                            <log message="Loading entity from DB..." loggingLevel="DEBUG" />
            
                            <toD uri="openmrs:extract?tableToSync=${exchangeProperty.senderSyncMessage.tableName.toUpperCase()}&amp;uuid=${exchangeProperty.senderSyncMessage.identifier}" />
            
                            <log loggingLevel="DEBUG" message="Loaded entity -> ${body}" />
            
                            <choice>
                                <when>
                                    <simple>${body.size()} == 1</simple>
                                    <setBody>
                                        <jsonpath>$[0]</jsonpath>
                                    </setBody>
                                </when>
                                <otherwise>
                                    <setBody>
                                        <simple>${null}</simple>
                                    </setBody>
                                </otherwise>
                            </choice>
                        </otherwise>
                    </choice>
            
                    <when>
                        <simple>${body} == null</simple>
    
                        <log message="Entity not found for request with uuid: ${exchangeProperty.senderSyncMessage.requestUuid}" />
    
                        <setBody>
                            <spel>#{new org.openmrs.eip.component.model.SyncModel()}</spel>
                        </setBody>
                        <script>
                            <spel>
                                #{body.setMetadata(new org.openmrs.eip.component.model.SyncMetadata())}
                            </spel>
                        </script>
                    </when>
            
                    <script>
                        <spel>
                            #{body.metadata.setSourceIdentifier('{{db-sync.senderId}}')}
                            #{body.metadata.setDateSent(T(java.time.LocalDateTime).now())}
                            #{body.metadata.setOperation(getProperty('senderSyncMessage').operation)}
                            <!-- TODO(luis.pinto) - validate with JP/Wyclif: SenderSyncMessage only have messageUuid, that stores event request uuid. -->
                            <!-- Should we use the same uuid to set the two metadata uuid here? -->
                            #{body.metadata.setRequestUuid(getProperty('senderSyncMessage').messageUuid)}
                            #{body.metadata.setMessageUuid(getProperty('senderSyncMessage').messageUuid)}
                        </spel>
                    </script>
                    <setBody>
                        <method beanType="org.openmrs.eip.component.utils.JsonUtils" method="marshall(${body})" />
                    </setBody>
    
                    <log loggingLevel="DEBUG" message="Sync payload -> ${body}" />
    
                    <when>
                        <simple>{{openmrs.eip.dbsync.encryption.enabled}} == true</simple>
                        <log message="Encrypting entity payload.." />
    
                        <process ref="pgpEncryptService" />
    
                        <log message="Encrypted entity payload -> ${body}" loggingLevel="TRACE" />
                    </when>
    
                    <log message="Sending entity to sync destination: {{camel.output.endpoint}}" />
    
                    <toD uri="{{camel.output.endpoint}}" />
    
                    <log message="Entity sent! Updating request status to sent." />
                    
                    <script>
                        <spel>
                            #{getProperty('senderSyncMessage').setSent(true)}
                        </spel>
                    </script>
                    <setBody>
                        <simple>${exchangeProperty.senderSyncMessage}</simple>
                    </setBody>

                    <log message="Saving updates for sender sync message" loggingLevel="DEBUG" />

                    <to uri="jpa:SenderSyncMessage" />

                    <log message="Successfully saved updates for sender sync message" loggingLevel="DEBUG" />

                    <log message="Successfully sent and updated sender sync message" />
                    
                </split>
            </when>
            <otherwise>
                <log message="No sender sync messages found" loggingLevel="DEBUG" />
            </otherwise>
        </choice>
    </route>
</routes>
