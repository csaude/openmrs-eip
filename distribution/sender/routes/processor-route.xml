<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="db-event-processor" errorHandlerRef="outBoundErrorHandler">
        <from uri="direct:db-event-processor" />

        <log message="Processing db event: ${body}" loggingLevel="DEBUG" />

        <when>
            <!-- For a subclass table, fetch the identifier(uuid) from the parent table e.g person.uuid value for patient table joining on the FK -->
            <simple>${body.identifier} == null &amp;&amp; ${exchangeProperty.is-subclass} == true</simple>
            <choice>
                <when>
                    <simple>${body.tableName} == 'patient'</simple>
                    <setProperty name="debezium-refTable">
                        <constant>person</constant>
                    </setProperty>
                    <setProperty name="debezium-refColumn">
                        <constant>person_id</constant>
                    </setProperty>
                    <setProperty name="debezium-column">
                        <constant>patient_id</constant>
                    </setProperty>
                </when>
                <otherwise>
                    <setProperty name="debezium-refTable">
                        <constant>orders</constant>
                    </setProperty>
                    <setProperty name="debezium-refColumn">
                        <constant>order_id</constant>
                    </setProperty>
                    <setProperty name="debezium-column">
                        <constant>order_id</constant>
                    </setProperty>
                </otherwise>
            </choice>

            <log message="Looking up uuid for ${body.tableName} from ${exchangeProperty.debezium-refTable} table" loggingLevel="DEBUG" />

            <toD uri="sql:SELECT uuid FROM ${exchangeProperty.debezium-refTable} WHERE ${exchangeProperty.debezium-refColumn}='${body.primaryKeyId}'?dataSource=openmrsDataSource" />

            <when>
                <simple>${body.size()} == 1</simple>
                <script>
                    <spel>#{getProperty('event').setIdentifier(body[0].get('uuid'))}</spel>
                </script>
            </when>
        </when>

        <setBody>
            <simple>${exchangeProperty.event}</simple>
        </setBody>

        <toD uri="direct:out-bound-db-sync" />

        <!-- TODO Move deleting of item from queue to the retry-route, reason it is here is because inside a split exceptions are swallowed  -->
        <when>
            <simple>${exchangeProperty.retry-item-id} != null</simple>
            <log message="Removing from the error queue an item with id: ${exchangeProperty.retry-item-id}" />

            <toD uri="jpa:SenderRetryQueueItem?query=DELETE FROM SenderRetryQueueItem WHERE id = ${exchangeProperty.retry-item-id}" />

            <log loggingLevel="DEBUG" message="Successfully removed from the error queue an item with id: ${exchangeProperty.retry-item-id}" />
        </when>

        <when>
            <simple>${exchangeProperty.dbzmEvent} != null</simple>
            <log message="Removing item with id: ${exchangeProperty.dbzmEvent.id} from the debezium event queue" loggingLevel="DEBUG" />

            <toD uri="jpa:DebeziumEvent?query=DELETE FROM DebeziumEvent WHERE id = ${exchangeProperty.dbzmEvent.id}" />

            <log message="Successfully removed item with id: ${exchangeProperty.dbzmEvent.id} from the debezium event queue" />
        </when>

        <log message="Done processing db event" loggingLevel="DEBUG" />
    </route>

</routes>
