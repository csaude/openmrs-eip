<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet author="wluyima" id="20240102-1947" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_created" tableName="receiver_sync_msg"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_sync_msg.date_created column</comment>

        <addNotNullConstraint columnName="date_created" tableName="receiver_sync_msg" columnDataType="DATETIME(3)"/>
    </changeSet>

    <changeSet author="wluyima" id="20240103-0840" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_id" tableName="receiver_retry_queue"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.site_id column</comment>

        <addNotNullConstraint columnName="site_id" tableName="receiver_retry_queue" columnDataType="BIGINT"/>
    </changeSet>

    <changeSet author="wluyima" id="20240103-0841" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_id" tableName="receiver_conflict_queue"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_conflict_queue.site_id column</comment>

        <addNotNullConstraint columnName="site_id" tableName="receiver_conflict_queue" columnDataType="BIGINT"/>
    </changeSet>

    <changeSet author="wluyima" id="20240103-0951" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message_uuid" tableName="receiver_sync_msg"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_sync_msg.message_uuid column</comment>

        <addNotNullConstraint columnName="message_uuid" tableName="receiver_sync_msg" columnDataType="VARCHAR(38)"/>
    </changeSet>

    <changeSet author="wluyima" id="20240103-0952" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message_uuid" tableName="receiver_synced_msg"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_synced_msg.message_uuid column</comment>

        <addNotNullConstraint columnName="message_uuid" tableName="receiver_synced_msg" columnDataType="VARCHAR(38)"/>
    </changeSet>

    <changeSet author="wluyima" id="20240103-0953" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message_uuid" tableName="receiver_retry_queue"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.message_uuid column</comment>

        <addNotNullConstraint columnName="message_uuid" tableName="receiver_retry_queue" columnDataType="VARCHAR(38)"/>
    </changeSet>

    <changeSet author="wluyima" id="20240103-0954" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message_uuid" tableName="receiver_conflict_queue"/>
        </preConditions>
        <comment>Adding not null constraint to receiver_conflict_queue.message_uuid column</comment>

        <addNotNullConstraint columnName="message_uuid" tableName="receiver_conflict_queue"
                              columnDataType="VARCHAR(38)"/>
    </changeSet>

    <changeSet author="wluyima" id="20240123-0815" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mgt_jms_msg"/>
            </not>
        </preConditions>
        <comment>Adding mgt_jms_msg table</comment>
        <createTable tableName="mgt_jms_msg">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="msg_id" type="VARCHAR(38)">
                <constraints unique="true"/>
            </column>
            <column name="site_id" type="VARCHAR(255)"/>
            <column name="msg_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="body" type="MEDIUMBLOB">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME(3)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="mgt_jms_msg_site_fk"
                                 baseTableName="mgt_jms_msg"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="identifier"/>
    </changeSet>

    <changeSet author="wluyima" id="20240131-0901" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mgt_reconciliation"/>
            </not>
        </preConditions>
        <comment>Adding mgt_reconciliation table</comment>
        <createTable tableName="mgt_reconciliation">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="identifier" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20240131-0902" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mgt_site_reconciliation"/>
            </not>
        </preConditions>
        <comment>Adding mgt_site_reconciliation table</comment>
        <createTable tableName="mgt_site_reconciliation">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_completed" type="DATETIME"/>
        </createTable>
        <addForeignKeyConstraint constraintName="mgt_site_reconciliation_site_fk"
                                 baseTableName="mgt_site_reconciliation"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20240131-0903" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mgt_table_reconciliation"/>
            </not>
        </preConditions>
        <comment>Adding mgt_table_reconciliation table</comment>
        <createTable tableName="mgt_table_reconciliation">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="site_reconciliation_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="row_count" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="remote_start_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="processed_count" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="last_batch_received" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="completed" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_changed" type="DATETIME"/>
        </createTable>
        <addUniqueConstraint tableName="mgt_table_reconciliation" columnNames="site_reconciliation_id, table_name"
                             constraintName="mgt_table_site_uk"/>
        <addForeignKeyConstraint constraintName="mgt_table_site_reconciliation_fk"
                                 baseTableName="mgt_table_reconciliation"
                                 baseColumnNames="site_reconciliation_id"
                                 referencedTableName="mgt_site_reconciliation"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20240131-0904" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mgt_reconciliation_msg"/>
            </not>
        </preConditions>
        <comment>Adding mgt_reconciliation_msg table</comment>
        <createTable tableName="mgt_reconciliation_msg">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="batch_size" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="last_table_batch" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="MEDIUMTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="processed_count" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="mgt_reconciliation_msg_site_fk"
                                 baseTableName="mgt_reconciliation_msg"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20240226-1200" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="missing_entity"/>
            </not>
        </preConditions>
        <comment>Adding missing_entity table</comment>
        <createTable tableName="missing_entity">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="in_sync_queue" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="in_error_queue" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="missing_entity_site_fk"
                                 baseTableName="missing_entity"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20240229-1015" labels="1.6.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="undeleted_entity"/>
            </not>
        </preConditions>
        <comment>Adding undeleted_entity table</comment>
        <createTable tableName="undeleted_entity">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="in_sync_queue" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="in_error_queue" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="undeleted_entity_site_fk"
                                 baseTableName="undeleted_entity"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>
