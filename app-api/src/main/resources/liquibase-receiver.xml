<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog context="receiver"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet author="wluyima" id="20210202-1100">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_retry_queue"/>
            </not>
        </preConditions>
        <comment>Adding receiver_retry_queue table</comment>
        
        <createTable tableName="receiver_retry_queue">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="attempt_count" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="cause_message" type="VARCHAR(1024)"/>
            <column name="message" type="VARCHAR(1024)"/>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_changed" type="DATETIME"/>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1101">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_conflict_queue"/>
            </not>
        </preConditions>
        <comment>Adding receiver_conflict_queue table</comment>

        <createTable tableName="receiver_conflict_queue">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="is_resolved" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1050">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Adding site_info table</comment>

        <createTable tableName="site_info">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1055">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_status"/>
            </not>
        </preConditions>
        <comment>Adding receiver_sync_status table</comment>

        <createTable tableName="receiver_sync_status">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="site_info_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="last_sync_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="sync_status_site_fk"
                                 baseTableName="receiver_sync_status"
                                 baseColumnNames="site_info_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2101">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="exception_type" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add exception_type column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="exception_type" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2102">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting receiver_retry_queue.exception_type for existing rows</comment>

        <update tableName="receiver_retry_queue">
            <column name="exception_type" value="org.openmrs.eip.component.exception.EIPException" />
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2103">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="receiver_retry_queue" columnName="exception_type" />
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.exception_type</comment>

        <addNotNullConstraint tableName="receiver_retry_queue" columnName="exception_type" />
    </changeSet>

    <changeSet author="wluyima" id="20210601-1410">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message" tableName="receiver_retry_queue" />
            <columnExists columnName="cause_message" tableName="receiver_retry_queue" />
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue WHERE cause_message IS NOT NULL
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Copying values from receiver_retry_queue.cause_message to receiver_retry_queue.message column</comment>

        <update tableName="receiver_retry_queue">
            <column name="message" valueComputed="cause_message" />
            <where>cause_message IS NOT NULL</where>
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20210601-1411">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="cause_message" tableName="receiver_retry_queue" />
        </preConditions>
        <comment>Drop receiver_retry_queue.cause_message column</comment>

        <dropColumn tableName="receiver_retry_queue" columnName="cause_message" />
    </changeSet>

</databaseChangeLog>
